
{{#if products}}
<!-- Shoping Cart -->
<div class="bg0 p-t-75 p-b-85 mt-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-10 col-xl-7 m-lr-auto m-b-50">
                <div class="m-l-25 m-r--38 m-lr-0-xl">


                    <div class="wrap-table-shopping-cart">
                        <table class="table-shopping-cart">
                            <tr class="table_head">

                                <th class="column-1">Name</th>
                                <th class="column-">Price</th>
                                <th class="column-2">Quantity</th>
                                <th class="column-2">Total</th>
                            </tr>
                            {{#each products}}
                            <tr class="table_row">

                                <td class="column-1">{{this.product.name}}</td>
                                <td class="column-3"><span
                                        style="font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;">₹
                                    </span> {{this.product.price}}</td>
                                <td class="column-2"> {{this.quantity}}</td>
                                <td class="column-2"><span
                                        style="font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;">₹
                                    </span> {{this.productTotal}}</td>

                            </tr>
                            {{/each}}
                        </table>
                    </div>

                    <div class="flex-w flex-sb-m bor15 p-t-18 p-b-15 p-lr-40 p-lr-15-sm">
                        <div class="flex-w flex-m m-r-20 m-tb-5">
                            <input class="stext-104 cl2 plh4 size-117 bor13 p-lr-20 m-r-10 m-tb-5" type="text"
                                name="coupon" placeholder="Coupon Code">

                            <div
                                class="flex-c-m stext-101 cl2 size-118 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-5">
                                Apply coupon
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <form id="checkoutForm" class="col-sm-10 col-lg-7 col-xl-5 m-lr-auto m-b-50">
                <div class="bor10 p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm">
                    <h4 class="mtext-109 cl2 p-b-30">
                        Cart Totals
                    </h4>

                    <div class="flex-w flex-t bor12 p-b-13">
                        <div class="size-208">
                            <span class="stext-110 cl2">
                                Subtotal:
                            </span>
                        </div>

                        <div class="size-209">
                            <span class="mtext-110 cl2">
                                <span
                                    style="font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;">₹
                                </span> {{totalAmount}}
                            </span>
                        </div>
                    </div>
                    <div class="flex-w flex-t bor12 p-b-13 py-3">
                        <div class="size-208">
                            <span class="stext-110 cl2">
                                Delivery:
                            </span>
                        </div>

                        <div class="size-209">
                            <span class="mtext-110 cl2">
                                <span
                                    style="font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;">₹
                                </span>0
                            </span>
                        </div>
                    </div>
                    <div class="flex-w flex-t bor12 p-b-13 py-3">
                        <div class="size-208">
                            <span class="stext-110 cl2">
                                Offer:
                            </span>
                        </div>

                        <div class="size-209">
                            <span class="mtext-110 cl2">
                                <span
                                    style="font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;">₹
                                </span>0
                            </span>
                        </div>
                    </div>

                    <div class="flex-w flex-t bor12 p-t-15 p-b-30">
                        <div class="size-208 w-full-ssm">
                            <span class="stext-110 cl2">
                                Shipping Address:
                            </span>
                        </div>

                        <div class="size-209 p-r-18 p-r-0-sm w-full-ssm">

                            <div class="p-t-15">

                                <div class="pb-3">
                                    <div class="rs1-select2 rs2-select2  bg0 m-b-12 m-t-9 ">
                                        {{#if address}}
                                        {{#each address}}
                                        <div class=" d-flex">
                                            <input type="radio" value="{{this.shippingAddress.time}}" name="address"
                                                required>
                                            <label class="p-2">
                                                {{this.shippingAddress.fname}} {{this.shippingAddress.lname}},
                                                {{this.shippingAddress.address}},{{this.shippingAddress.city}},
                                                {{this.shippingAddress.landmark}},{{this.shippingAddress.state}},
                                                {{this.shippingAddress.pincode}}
                                            </label>
                                        </div>
                                        {{/each}}
                                        {{else}}
                                        <p class="text-danger">Please Add Address</p>
                                        <input id="hiddenAddressInput" type="text" hidden>

                                        {{/if}}
                                    </div>
                                </div>



                                <div class=" flex-w">
                                    <a href="/add-address">
                                        <div
                                            class="flex-c-m stext-101 cl2 size-115 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer">
                                            Add Address
                                        </div>
                                    </a>
                                </div>

                            </div>
                        </div>
                    </div>
                    <div class="flex-w flex-t bor12 p-t-15 p-b-30">
                        <div class="size-208 w-full-ssm">
                            <span class="stext-110 cl2">
                                Payment Method:
                            </span>
                        </div>

                        <div class="size-209 p-r-18 p-r-0-sm w-full-ssm">

                            <div class="rs1-select2 rs2-select2 bg0 m-b-12 m-t-9">
                                <div class="d-flex p-3">
                                    <input type="radio" value="COD" name="payment_method" required>
                                    <label class="mx-2" for="">Cash on Delivery</label>
                                </div>
                                <div class="d-flex p-3">
                                    <input type="radio" value="OnlinePayment" name="payment_method" required>
                                    <label class="mx-2" for="">Online Payment</label>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class=" flex-w flex-t p-t-27 p-b-33">
                        <div class="size-208">
                            <span class="mtext-101 cl2">
                                Total:
                            </span>
                        </div>

                        <div class="size-209 p-t-1">
                            <span class="mtext-110 cl2">
                                <span
                                    style="font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;">₹
                                </span> {{totalAmount}}
                            </span>
                        </div>
                    </div>

                    <button id="proceed"
                        class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer">
                        Proceed to Checkout
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>
{{else}}
<section>
    <div class="container p-5 mt-5">
        <h1 style="font-size: 2rem; font-weight: 600;" class="text-center">No Items for Checkout</h1>
        <img class="img-fluid" style="display: block;margin-left:auto;margin-right: auto;"
            src="/public/codeStoreImages/cart-empty-illustration.jpg" alt="no cart items">
    </div>
</section>
{{/if}}
<script>
    let emptyAddress = document.getElementById('hiddenAddressInput')
    if (emptyAddress.value = '') {
        document.getElementById('proceed').setAttribute('disabled', '')
    }
</script>

<script>
    $('#checkoutForm').submit((e) => {
        e.preventDefault()
        $.ajax({
            url: '/checkout',
            method: 'post',
            data: $('#checkoutForm').serialize(),
            success: (response) => {
                if (response.codStatus) {
                    Swal.fire({
                        title: 'Thank You!',
                        text: "Your Order placed successfully",
                        icon: 'success',
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Continue Shopping',
                        footer: '<a href="/orders">View Orders</a>'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            location.href = '/products'
                        }
                    })
                    document.getElementById('proceed').setAttribute('disabled', '')

                } else {
                    razorpayPayment(response)
                }
            }
        })
    })

    function razorpayPayment(order) {
        var options = {
            "key": "rzp_test_vbW5DnxgpGavaj", // Enter the Key ID generated from the Dashboard
            "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
            "currency": "INR",
            "name": "CodeStore",
            "description": "Test Transaction",
            "image": "https://example.com/your_logo",
            "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
            "handler": function (response) {
                verifyPayment(response, order)
            },
            "prefill": {
                "name": "Gaurav Kumar",
                "email": "gaurav.kumar@example.com",
                "contact": "9999999999"
            },
            "notes": {
                "address": "Razorpay Corporate Office"
            },
            "theme": {
                "color": "#3399cc"
            }
        };
        var rzp1 = new Razorpay(options);


        rzp1.open();


    }
    function verifyPayment(payment, order) {
        $.ajax({
            url: '/verify-payment',
            method: 'post',
            data: {
                payment,
                order
            },
            success: (response) => {
                if (reponse.status) {
                    location.reload('/orders')
                }


            }

        })
    }
</script>